rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAuthor(rsc) {
      return rsc.data.authorId == request.auth.uid;
    }
    
    function isAdmin() {
      // Safe read (admin role check)
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if true; 
      allow write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // --- Posts Collection ---
    
    match /posts/{postId} {
      
      // READ
      allow read: if resource.data.status == 'approved' 
                  || (isAuthenticated() && (isAuthor(resource) || isAdmin()));
      
      // CREATE
      allow create: if isAuthenticated() 
                    && request.resource.data.authorId == request.auth.uid
                    && (request.resource.data.status == 'draft' || request.resource.data.status == 'pending');

      // UPDATE
      allow update: if isAdmin() 
                    || (isAuthenticated() && isAuthor(resource) 
                        // Prevent setting restricted statuses
                        && !(request.resource.data.status in ['approved', 'rejected'])
                        // Prevent changing system fields
                        && request.resource.data.authorId == resource.data.authorId
                        // CRITICAL: Prevent client from changing counters directly
                        && request.resource.data.likeCount == resource.data.likeCount
                        && request.resource.data.commentCount == resource.data.commentCount
                       );

      // DELETE
      allow delete: if isAdmin() 
                    || (isAuthenticated() && isAuthor(resource) && resource.data.status == 'draft');

      // --- Likes Subcollection ---
      // posts/{postId}/likes/{userId}
      match /likes/{userId} {
        allow read: if isAuthenticated();
        // Create: Only allow if document ID matches authenticated User ID
        allow create: if isAuthenticated() && request.auth.uid == userId;
        // Delete: Only allow if document ID matches authenticated User ID
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }

      // --- Comments Subcollection ---
      // posts/{postId}/comments/{commentId}
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        // Create: Allow any authenticated user to comment
        allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
        // Delete: Allow author or admin to delete
        allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
      }
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
