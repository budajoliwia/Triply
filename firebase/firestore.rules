rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAuthor(rsc) {
      return rsc.data.authorId == request.auth.uid;
    }

    function isPostAuthorById(postId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid;
    }
    
    function isAdmin() {
      // Safe read (admin role check)
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function userCountersUnchanged() {
      // Block any client-side updates to counters.
      // For older docs, treat missing counters as 0.
      let currentFollowers = resource.data.get('followersCount', 0);
      let currentFollowing = resource.data.get('followingCount', 0);
      let nextFollowers = request.resource.data.get('followersCount', currentFollowers);
      let nextFollowing = request.resource.data.get('followingCount', currentFollowing);
      return nextFollowers == currentFollowers && nextFollowing == currentFollowing;
    }

    function isValidBio() {
      return !('bio' in request.resource.data)
        || request.resource.data.bio == null
        || (request.resource.data.bio is string && request.resource.data.bio.size() <= 160);
    }

    function isValidAvatarPath(userId) {
      return !('avatarPath' in request.resource.data)
        || request.resource.data.avatarPath == null
        || (request.resource.data.avatarPath is string
            && request.resource.data.avatarPath == ('avatars/' + userId + '.jpg'));
    }

    function onlyProfileFieldsChanged() {
      // Allow editing ONLY user-facing profile fields from the client.
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bio', 'avatarPath']);
    }
    
    // Allow ONLY commentCount +/- 1 (and updatedAt change) while all other fields stay identical.
    function isCommentCountUpdate(resource, requestResource) {
      let currentCount = resource.data.get('commentCount', 0);
      
      return requestResource.data.authorId == resource.data.authorId
             && requestResource.data.text == resource.data.text
             && requestResource.data.tags == resource.data.tags
             && requestResource.data.photo == resource.data.photo
             && requestResource.data.status == resource.data.status
             && requestResource.data.likeCount == resource.data.get('likeCount', 0)
             && requestResource.data.createdAt == resource.data.createdAt
             && (
               requestResource.data.commentCount == currentCount + 1 ||
               requestResource.data.commentCount == currentCount - 1
             );
      // updatedAt may differ; we intentionally do NOT compare it here.
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if true; 
      // Create user doc (registration)
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Production hardening:
      // - ONLY the owner may update their own profile fields (bio/avatarPath)
      // - clients cannot modify role, limits, counters, etc. (Cloud Functions bypass rules)
      allow update: if isAuthenticated()
                    && request.auth.uid == userId
                    && userCountersUnchanged()
                    && onlyProfileFieldsChanged()
                    && isValidBio()
                    && isValidAvatarPath(userId);
      allow delete: if false;

      // --- Following Subcollection ---
      // users/{userId}/following/{targetUid}
      match /following/{targetUid} {
        // Anyone can read who someone follows? Let's say yes for now, or just authenticated.
        allow read: if isAuthenticated();
        // Only the user themselves can add/remove people they follow
        allow create, delete: if isAuthenticated() && request.auth.uid == userId;
        allow update: if false;
      }

      // --- Followers Subcollection ---
      // users/{userId}/followers/{followerUid}
      match /followers/{followerUid} {
        allow read: if isAuthenticated();
        // Only allow the follower to create/delete their own follower edge.
        // Path: users/{targetUid}/followers/{request.auth.uid}
        allow create, delete: if isAuthenticated() && request.auth.uid == followerUid;
        allow update: if false;
      }
    }

    // --- Posts Collection ---
    
    match /posts/{postId} {
      
      // READ
      allow read: if resource.data.status == 'approved' 
                  || (isAuthenticated() && (isAuthor(resource) || isAdmin()));
      
      // CREATE
      allow create: if isAuthenticated() 
                    && request.resource.data.authorId == request.auth.uid
                    && (request.resource.data.status == 'draft' || request.resource.data.status == 'pending');

      // UPDATE
      allow update: if isAdmin() 
                    || (
                      isAuthenticated()
                      && (
                        (
                          // Author updates (same as before, counters immutable here)
                          isAuthor(resource) 
                          // Prevent setting restricted statuses
                          && !(request.resource.data.status in ['approved', 'rejected'])
                          // Prevent changing system fields
                          && request.resource.data.authorId == resource.data.authorId
                          // CRITICAL: Prevent client from changing counters directly
                          && request.resource.data.likeCount == resource.data.likeCount
                          && request.resource.data.commentCount == resource.data.commentCount
                        )
                        ||
                        (
                          // Comment counter bump (allow any authenticated user)
                          isCommentCountUpdate(resource, request.resource)
                        )
                      )
                    );

      // DELETE
      allow delete: if isAdmin() 
                    || (isAuthenticated() && isAuthor(resource) && resource.data.status == 'draft');

      // --- Likes Subcollection ---
      // posts/{postId}/likes/{userId}
      match /likes/{userId} {
        allow read: if isAuthenticated();
        // Create: Only allow if document ID matches authenticated User ID
        allow create: if isAuthenticated() && request.auth.uid == userId;
        // Delete: Only allow if document ID matches authenticated User ID
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }

      // --- Comments Subcollection ---
      // posts/{postId}/comments/{commentId}
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        // Create: Allow any authenticated user to comment
        allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
        // Delete: Allow author or admin to delete
        allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
      }

      // --- Post Events Subcollection (audit log) ---
      // posts/{postId}/postEvents/{eventId}
      match /postEvents/{eventId} {
        // Mirror post visibility: admin or post author.
        allow read: if isAuthenticated() && (isAdmin() || isPostAuthorById(postId));

        // Clients may ONLY create clean moderation events (Cloud Functions bypass rules).
        allow create: if isAuthenticated()
                      && isAdmin()
                      && request.resource.data.keys().hasOnly(['type', 'actorId', 'createdAt'])
                      && request.resource.data.actorId == request.auth.uid
                      && request.resource.data.type in ['approved', 'rejected']
                      && ('createdAt' in request.resource.data)
                      && request.resource.data.createdAt is timestamp;

        allow update, delete: if false;
      }
    }

    // --- Notifications Collection ---
    // notifications/{notificationId}
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && request.auth.uid == resource.data.targetUserId;

      // Clients cannot create or delete notifications (backend only).
      allow create, delete: if false;

      // Optional: allow client to mark as read, without changing other fields.
      allow update: if isAuthenticated()
                    && request.auth.uid == resource.data.targetUserId
                    // only allow transitioning to read=true
                    && resource.data.read == false
                    && request.resource.data.read == true
                    // and only the 'read' field may change
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
